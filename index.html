<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PDF Translator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Lato:wght@300;400;700&display=swap');
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #111318; --surface: #1a1d24; --surface2: #22262f;
      --border: #2e323d; --accent: #4f8ef7; --green: #4ecb8d;
      --text: #dde1ea; --muted: #5c6278; --error: #f87171;
    }
    body { font-family: 'Lato', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    header { padding: 16px 32px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .logo { font-family: 'Playfair Display', serif; font-size: 22px; color: #fff; }
    .logo span { color: var(--accent); }
    .tagline { font-size: 12px; color: var(--muted); }
    main { max-width: 1000px; margin: 0 auto; padding: 40px 24px; }
    #upload-section { display: block; }
    #viewer-section { display: none; }
    .upload-zone {
      border: 2px dashed var(--border); border-radius: 20px; padding: 72px 40px;
      text-align: center; cursor: pointer; background: var(--surface);
      transition: border-color 0.2s, background 0.2s;
    }
    .upload-zone:hover, .upload-zone.drag-over { border-color: var(--accent); background: #1a2035; }
    .upload-zone .icon { font-size: 52px; margin-bottom: 16px; }
    .upload-zone h2 { font-family: 'Playfair Display', serif; font-size: 26px; color: #fff; margin-bottom: 8px; }
    .upload-zone p { color: var(--muted); font-size: 14px; }
    #file-input { display: none; }
    .controls { display: flex; gap: 12px; margin-top: 28px; align-items: center; justify-content: center; flex-wrap: wrap; }
    .lang-label { font-size: 13px; color: var(--muted); }
    select { background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 10px 16px; border-radius: 10px; font-size: 14px; font-family: 'Lato', sans-serif; cursor: pointer; outline: none; }
    select:focus { border-color: var(--accent); }
    .btn-primary { background: var(--accent); color: #fff; border: none; padding: 13px 48px; border-radius: 12px; font-size: 15px; font-family: 'Lato', sans-serif; font-weight: 700; cursor: pointer; transition: opacity 0.2s, transform 0.1s; display: block; margin: 28px auto 0; }
    .btn-primary:hover { opacity: 0.85; transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }
    #status { margin-top: 20px; text-align: center; font-size: 14px; color: var(--muted); min-height: 22px; }
    #status.error { color: var(--error); }
    #status.success { color: var(--green); }
    .progress-wrap { width: 100%; max-width: 360px; margin: 14px auto 0; background: var(--surface2); border-radius: 10px; height: 6px; overflow: hidden; display: none; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, var(--accent), var(--green)); border-radius: 10px; width: 0%; transition: width 0.5s ease; }
    .viewer-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
    .viewer-title { font-family: 'Playfair Display', serif; font-size: 20px; color: #fff; }
    .viewer-actions { display: flex; gap: 10px; }
    .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); padding: 9px 20px; border-radius: 10px; font-size: 13px; font-family: 'Lato', sans-serif; cursor: pointer; }
    .btn-secondary:hover { background: var(--border); }
    .btn-download { background: var(--green); color: #111; border: none; padding: 9px 20px; border-radius: 10px; font-size: 13px; font-family: 'Lato', sans-serif; font-weight: 700; cursor: pointer; text-decoration: none; display: inline-block; }
    .btn-download:hover { opacity: 0.85; }
    .panels { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 18px; }
    @media (max-width: 640px) { .panels { grid-template-columns: 1fr; } }
    .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
    .panel-header { padding: 10px 16px; border-bottom: 1px solid var(--border); font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); display: flex; align-items: center; gap: 8px; }
    .dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    #pdf-canvas { display: block; width: 100%; height: auto; }
    #translation-container { padding: 18px; max-height: 600px; overflow-y: auto; }
    .block-item { margin-bottom: 16px; padding: 12px 14px; background: var(--surface2); border-radius: 10px; border-left: 3px solid var(--accent); font-size: 13px; line-height: 1.8; }
    .block-original { color: var(--muted); font-size: 11px; margin-bottom: 6px; line-height: 1.6; }
    .block-translated { color: var(--text); }
    .page-nav { display: flex; align-items: center; justify-content: center; gap: 16px; margin-top: 16px; }
    .page-nav button { background: var(--surface2); border: 1px solid var(--border); color: var(--text); width: 36px; height: 36px; border-radius: 9px; font-size: 18px; cursor: pointer; transition: background 0.15s; }
    .page-nav button:hover:not(:disabled) { background: var(--border); }
    .page-nav button:disabled { opacity: 0.3; cursor: not-allowed; }
    .page-info { font-size: 13px; color: var(--muted); min-width: 80px; text-align: center; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; margin-right: 7px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<header>
  <div class="logo">PDF<span>.</span>Translate</div>
  <div class="tagline">JP / KO / ES ‚Üí English ¬∑ Free</div>
</header>

<main>
  <div id="upload-section">
    <div class="upload-zone" id="drop-zone">
      <div class="icon">üìÑ</div>
      <h2>Drop your PDF here</h2>
      <p>or click to browse your files</p>
      <input type="file" id="file-input" accept=".pdf"/>
    </div>

    <div class="controls">
      <span class="lang-label">Translate from</span>
      <select id="source-lang">
        <option value="japanese" selected>Japanese üáØüáµ</option>
        <option value="korean">Korean üá∞üá∑</option>
        <option value="spanish">Spanish üá™üá∏</option>
        <option value="auto">Auto-detect</option>
      </select>
      <span style="font-size:20px;color:var(--muted)">‚Üí</span>
      <select disabled><option>English üá¨üáß</option></select>
    </div>

    <button class="btn-primary" id="translate-btn" disabled>Translate PDF</button>
    <div id="status"></div>
    <div class="progress-wrap" id="progress-wrap">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>

  <div id="viewer-section">
    <div class="viewer-header">
      <div class="viewer-title" id="viewer-filename">Translated Document</div>
      <div class="viewer-actions">
        <button class="btn-secondary" id="back-btn">‚Üê New PDF</button>
        <a class="btn-download" id="download-link" href="#" download>‚¨á Download PDF</a>
      </div>
    </div>
    <div class="panels">
      <div class="panel">
        <div class="panel-header"><div class="dot" style="background:var(--accent)"></div>Original</div>
        <canvas id="pdf-canvas"></canvas>
      </div>
      <div class="panel">
        <div class="panel-header"><div class="dot" style="background:var(--green)"></div>English Translation</div>
        <div id="translation-container"></div>
      </div>
    </div>
    <div class="page-nav">
      <button id="prev-btn" disabled>‚Äπ</button>
      <span class="page-info" id="page-info">Page 1 of 1</span>
      <button id="next-btn" disabled>‚Ä∫</button>
    </div>
  </div>
</main>

<script>
  // ‚îÄ‚îÄ CONFIG: update this after deploying backend to Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // During local testing: http://localhost:8000
  // After deploying:      https://your-app-name.onrender.com
  const API = "https://pdf-translator-api-zpw3.onrender.com";
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let selectedFile = null, pdfDoc = null, previewData = null,
      currentPage = 1, translatedBlobUrl = null;

  const $ = id => document.getElementById(id);
  const dropZone     = $('drop-zone');
  const fileInput    = $('file-input');
  const translateBtn = $('translate-btn');
  const statusEl     = $('status');
  const progressWrap = $('progress-wrap');
  const progressBar  = $('progress-bar');
  const uploadSection = $('upload-section');
  const viewerSection = $('viewer-section');
  const pdfCanvas    = $('pdf-canvas');
  const translationContainer = $('translation-container');

  // ‚îÄ‚îÄ File selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  dropZone.addEventListener('click', () => fileInput.click());
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('drag-over'); const f = e.dataTransfer.files[0]; if (f) handleFile(f); });
  fileInput.addEventListener('change', () => { if (fileInput.files[0]) handleFile(fileInput.files[0]); });

  function handleFile(file) {
    if (!file.name.toLowerCase().endsWith('.pdf')) { setStatus('Please select a PDF file.', 'error'); return; }
    selectedFile = file;
    dropZone.querySelector('h2').textContent = file.name;
    dropZone.querySelector('p').textContent = (file.size / 1024).toFixed(0) + ' KB ¬∑ click to change';
    translateBtn.disabled = false;
    setStatus('');
  }

  // ‚îÄ‚îÄ Translate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  translateBtn.addEventListener('click', async () => {
    if (!selectedFile) return;
    translateBtn.disabled = true;
    progressWrap.style.display = 'block';
    animateProgress(0, 20, 500);
    setStatus('<span class="spinner"></span>Uploading PDF‚Ä¶');

    const sourceLang = $('source-lang').value;

    try {
      // Step 1: preview (text + translation)
      const fd1 = new FormData();
      fd1.append('file', selectedFile);
      fd1.append('source_lang', sourceLang);
      animateProgress(20, 60, 4000);
      setStatus('<span class="spinner"></span>Translating ‚Äî usually takes 5‚Äì15 seconds‚Ä¶');
      const r1 = await fetch(API + '/preview', { method: 'POST', body: fd1 });
      if (!r1.ok) { const e = await r1.json(); throw new Error(e.detail || 'Translation failed.'); }
      previewData = await r1.json();

      // Step 2: translated PDF
      const fd2 = new FormData();
      fd2.append('file', selectedFile);
      fd2.append('source_lang', sourceLang);
      animateProgress(60, 90, 2000);
      setStatus('<span class="spinner"></span>Rendering translated PDF‚Ä¶');
      const r2 = await fetch(API + '/translate', { method: 'POST', body: fd2 });
      if (!r2.ok) { const e = await r2.json(); throw new Error(e.detail || 'Render failed.'); }

      const blob = await r2.blob();
      if (translatedBlobUrl) URL.revokeObjectURL(translatedBlobUrl);
      translatedBlobUrl = URL.createObjectURL(blob);
      $('download-link').href = translatedBlobUrl;
      $('download-link').download = selectedFile.name.replace('.pdf', '_translated.pdf');

      const buf = await selectedFile.arrayBuffer();
      pdfDoc = await pdfjsLib.getDocument({ data: buf }).promise;

      animateProgress(90, 100, 300);
      currentPage = 1;
      $('viewer-filename').textContent = selectedFile.name.replace('.pdf', '') + ' ‚Äî Translated';
      setTimeout(() => showViewer(), 350);

    } catch (err) {
      setStatus(err.message, 'error');
      translateBtn.disabled = false;
      progressWrap.style.display = 'none';
    }
  });

  // ‚îÄ‚îÄ Viewer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function showViewer() {
    uploadSection.style.display = 'none';
    viewerSection.style.display = 'block';
    await renderPage(currentPage);
    updateNav();
  }

  async function renderPage(num) {
    const page = await pdfDoc.getPage(num);
    const vp = page.getViewport({ scale: 1.5 });
    pdfCanvas.width = vp.width; pdfCanvas.height = vp.height;
    await page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport: vp }).promise;
    renderTranslations(num - 1);
    $('page-info').textContent = 'Page ' + num + ' of ' + pdfDoc.numPages;
  }

  function renderTranslations(pageIdx) {
    translationContainer.innerHTML = '';
    const blocks = (previewData?.pages[pageIdx] || []).filter(b => b.translated?.trim());
    if (!blocks.length) {
      translationContainer.innerHTML = '<p style="color:var(--muted);padding:18px;font-size:13px;">No text blocks on this page.</p>';
      return;
    }
    blocks.forEach(b => {
      const el = document.createElement('div');
      el.className = 'block-item';
      el.innerHTML = '<div class="block-original">' + esc(b.original) + '</div><div class="block-translated">' + esc(b.translated) + '</div>';
      translationContainer.appendChild(el);
    });
  }

  function updateNav() {
    $('prev-btn').disabled = currentPage <= 1;
    $('next-btn').disabled = currentPage >= pdfDoc.numPages;
  }

  $('prev-btn').addEventListener('click', async () => { if (currentPage > 1) { currentPage--; await renderPage(currentPage); updateNav(); } });
  $('next-btn').addEventListener('click', async () => { if (currentPage < pdfDoc.numPages) { currentPage++; await renderPage(currentPage); updateNav(); } });

  $('back-btn').addEventListener('click', () => {
    viewerSection.style.display = 'none';
    uploadSection.style.display = 'block';
    translateBtn.disabled = false;
    progressWrap.style.display = 'none';
    setStatus('');
    selectedFile = null;
    dropZone.querySelector('h2').textContent = 'Drop your PDF here';
    dropZone.querySelector('p').textContent = 'or click to browse your files';
    if (translatedBlobUrl) URL.revokeObjectURL(translatedBlobUrl);
  });

  function setStatus(msg, type = '') { statusEl.innerHTML = msg; statusEl.className = type; }
  function animateProgress(from, to, dur) {
    const s = performance.now();
    (function step(n) {
      const t = Math.min((n - s) / dur, 1);
      progressBar.style.width = (from + (to - from) * t) + '%';
      if (t < 1) requestAnimationFrame(step);
    })(performance.now());
  }
  function esc(s) { return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>'); }
</script>
</body>
</html>
